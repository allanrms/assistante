name: Deploy to Production

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Deploy application
      id: deploy
      uses: appleboy/ssh-action@master
      with:
        host: 3.88.156.249
        username: ubuntu
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          cd /home/ubuntu/webapps/assistante/assistante
          git pull
          ../bin/pip install -r requirements.txt
          ../bin/python manage.py collectstatic --noinput
          ../bin/python manage.py migrate
          ../bin/python manage.py crontab remove
          ../bin/python manage.py crontab add
          sudo supervisorctl restart assistante