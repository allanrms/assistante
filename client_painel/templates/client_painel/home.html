{% extends 'client_painel/base.html' %}
{% load i18n %}

{% block title %}{% trans 'Dashboard' %}{% endblock %}

{% block page_title %}{% trans 'Dashboard' %}{% endblock %}

{% block extra_css %}
<style>
    .metric-card {
        background: var(--surface);
        border: 1px solid var(--border-light);
        border-radius: var(--radius-xl);
        padding: var(--spacing-xl);
        height: 100%;
        transition: all var(--transition-base);
        position: relative;
        overflow: hidden;
    }

    .metric-card:hover {
        transform: translateY(-4px);
        box-shadow: var(--shadow-lg);
    }

    .metric-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: var(--primary);
        transform: scaleX(0);
        transform-origin: left;
        transition: transform var(--transition-slow);
    }

    .metric-card:hover::before {
        transform: scaleX(1);
    }

    .metric-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: var(--spacing-lg);
    }

    .metric-icon-wrapper {
        width: 56px;
        height: 56px;
        border-radius: var(--radius-lg);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        position: relative;
    }

    .metric-icon-wrapper i {
        position: relative;
        z-index: 1;
    }

    .metric-body {
        display: flex;
        flex-direction: column;
    }

    .metric-value {
        font-size: 2.5rem;
        font-weight: 800;
        color: var(--text-primary);
        line-height: 1;
        margin-bottom: var(--spacing-sm);
        letter-spacing: -0.02em;
    }

    .metric-label {
        color: var(--text-secondary);
        font-weight: 600;
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: var(--spacing-md);
    }

    .metric-footer {
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
        font-size: 0.8125rem;
        font-weight: 600;
        padding: 0.375rem 0.75rem;
        border-radius: var(--radius-full);
        width: fit-content;
    }

    .metric-footer.success {
        color: var(--success);
        background: rgba(5, 150, 105, 0.1);
    }

    .metric-footer.warning {
        color: var(--warning);
        background: rgba(245, 158, 11, 0.1);
    }

    .metric-footer.info {
        color: var(--info);
        background: rgba(14, 165, 233, 0.1);
    }

    .quick-actions {
        background: var(--surface);
        border: 1px solid var(--border-light);
        border-radius: var(--radius-xl);
        padding: var(--spacing-xl);
    }

    .quick-action-btn {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
        padding: var(--spacing-md) var(--spacing-lg);
        border: 1px solid var(--border-light);
        border-radius: var(--radius-lg);
        background: var(--bg-secondary);
        color: var(--text-primary);
        text-decoration: none;
        transition: all var(--transition-base);
        font-weight: 600;
        width: 100%;
    }

    .quick-action-btn:hover {
        background: var(--primary);
        color: var(--text-inverse);
        border-color: var(--primary);
        transform: translateX(4px);
    }

    .quick-action-btn i {
        font-size: 1.25rem;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--surface);
        border-radius: var(--radius-md);
        transition: all var(--transition-base);
    }

    .quick-action-btn:hover i {
        background: rgba(255, 255, 255, 0.2);
        color: var(--text-inverse);
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--spacing-lg);
    }

    .section-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
    }

    .section-title i {
        color: var(--text-secondary);
    }

    .instance-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--spacing-lg);
        border-bottom: 1px solid var(--border-light);
        transition: all var(--transition-base);
    }

    .instance-item:last-child {
        border-bottom: none;
    }

    .instance-item:hover {
        background: var(--bg-secondary);
    }

    .instance-info {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
    }

    .instance-avatar {
        width: 48px;
        height: 48px;
        border-radius: var(--radius-lg);
        background: var(--primary);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--text-inverse);
        font-size: 1.25rem;
    }

    .instance-details h6 {
        font-weight: 700;
        margin: 0;
        color: var(--text-primary);
    }

    .instance-details small {
        color: var(--text-secondary);
    }

    .activity-timeline {
        position: relative;
        padding-left: var(--spacing-xl);
    }

    .activity-item {
        position: relative;
        padding-bottom: var(--spacing-lg);
        padding-left: var(--spacing-lg);
        border-left: 2px solid var(--border-light);
    }

    .activity-item:last-child {
        border-left: 2px solid transparent;
    }

    .activity-item::before {
        content: '';
        position: absolute;
        left: -7px;
        top: 0;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: var(--primary);
        border: 2px solid var(--surface);
    }

    .activity-item.success::before {
        background: var(--success);
    }

    .activity-item.warning::before {
        background: var(--warning);
    }

    .activity-item.error::before {
        background: var(--danger);
    }

    .activity-content {
        background: var(--bg-secondary);
        border-radius: var(--radius-md);
        padding: var(--spacing-md);
    }

    .activity-title {
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: var(--spacing-xs);
    }

    .activity-desc {
        font-size: 0.875rem;
        color: var(--text-secondary);
        margin-bottom: var(--spacing-xs);
    }

    .activity-time {
        font-size: 0.75rem;
        color: var(--text-tertiary);
    }

    .empty-state {
        text-align: center;
        padding: var(--spacing-2xl);
    }

    .empty-state i {
        font-size: 4rem;
        color: var(--text-tertiary);
        margin-bottom: var(--spacing-lg);
    }

    .empty-state h5 {
        color: var(--text-secondary);
        margin-bottom: var(--spacing-sm);
    }

    .empty-state p {
        color: var(--text-tertiary);
        margin-bottom: var(--spacing-lg);
    }

    .message-preview {
        display: flex;
        align-items: flex-start;
        gap: var(--spacing-md);
        padding: var(--spacing-lg);
        border-bottom: 1px solid var(--border-light);
        transition: all var(--transition-base);
    }

    .message-preview:last-child {
        border-bottom: none;
    }

    .message-preview:hover {
        background: var(--bg-secondary);
    }

    .message-avatar {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background: var(--primary);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--text-inverse);
        font-weight: 700;
        flex-shrink: 0;
    }

    .message-content {
        flex: 1;
        min-width: 0;
    }

    .message-header {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        margin-bottom: var(--spacing-xs);
    }

    .message-sender {
        font-weight: 700;
        color: var(--text-primary);
    }

    .message-time {
        font-size: 0.75rem;
        color: var(--text-tertiary);
    }

    .message-text {
        color: var(--text-secondary);
        font-size: 0.875rem;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .message-meta {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        margin-top: var(--spacing-xs);
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    .pulse {
        animation: pulse 2s ease-in-out infinite;
    }
</style>
{% endblock %}

{% block content %}
<!-- Top Actions Bar -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <p class="text-muted mb-0">
            <i class="bi bi-clock me-1"></i>
            {% trans 'Última atualização' %}: <span id="lastUpdate">{% trans 'agora' %}</span>
        </p>
    </div>
    <div class="d-flex gap-2">
        <button class="btn btn-outline-light" onclick="syncInstances()">
            <i class="bi bi-arrow-clockwise me-2"></i>
            {% trans 'Sincronizar' %}
        </button>
        <button class="btn btn-primary" onclick="window.location.href='{% url 'whatsapp_connector:instance_create' %}'">
            <i class="bi bi-plus-circle me-2"></i>
            {% trans 'Nova Instância' %}
        </button>
    </div>
</div>

<!-- Main Metrics Grid -->
<div class="row g-4 mb-4">
    <!-- Total Instances -->
    <div class="col-lg-3 col-md-6">
        <div class="metric-card">
            <div class="metric-header">
                <div class="metric-icon-wrapper" style="background: linear-gradient(135deg, rgba(0, 0, 0, 0.9), rgba(0, 0, 0, 0.7)); color: white;">
                    <i class="bi bi-phone-fill"></i>
                </div>
            </div>
            <div class="metric-body">
                <div class="metric-value">{{ total_instances|default:0 }}</div>
                <div class="metric-label">{% trans 'Total de Instâncias' %}</div>
                <div class="metric-footer success">
                    <i class="bi bi-check-circle-fill"></i>
                    {% trans 'Sistema ativo' %}
                </div>
            </div>
        </div>
    </div>

    <!-- Connected Instances -->
    <div class="col-lg-3 col-md-6">
        <div class="metric-card">
            <div class="metric-header">
                <div class="metric-icon-wrapper" style="background: linear-gradient(135deg, rgba(5, 150, 105, 0.2), rgba(5, 150, 105, 0.1)); color: #059669;">
                    <i class="bi bi-check-circle-fill"></i>
                </div>
            </div>
            <div class="metric-body">
                <div class="metric-value">{{ connected_instances|default:0 }}</div>
                <div class="metric-label">{% trans 'Conectadas' %}</div>
                <div class="metric-footer success">
                    <i class="bi bi-wifi"></i>
                    {% trans 'Online agora' %}
                </div>
            </div>
        </div>
    </div>

    <!-- Active Instances -->
    <div class="col-lg-3 col-md-6">
        <div class="metric-card">
            <div class="metric-header">
                <div class="metric-icon-wrapper" style="background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(245, 158, 11, 0.1)); color: #f59e0b;">
                    <i class="bi bi-lightning-charge-fill"></i>
                </div>
            </div>
            <div class="metric-body">
                <div class="metric-value">{{ active_instances|default:0 }}</div>
                <div class="metric-label">{% trans 'Ativas' %}</div>
                <div class="metric-footer warning">
                    <i class="bi bi-activity"></i>
                    {% trans 'Funcionando' %}
                </div>
            </div>
        </div>
    </div>

    <!-- Messages 24h -->
    <div class="col-lg-3 col-md-6">
        <div class="metric-card">
            <div class="metric-header">
                <div class="metric-icon-wrapper" style="background: linear-gradient(135deg, rgba(14, 165, 233, 0.2), rgba(14, 165, 233, 0.1)); color: #0ea5e9;">
                    <i class="bi bi-chat-dots-fill"></i>
                </div>
            </div>
            <div class="metric-body">
                <div class="metric-value">{{ recent_messages_count|default:0 }}</div>
                <div class="metric-label">{% trans 'Mensagens (24h)' %}</div>
                <div class="metric-footer info">
                    <i class="bi bi-graph-up"></i>
                    {% trans 'Últimas 24h' %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions & Recent Activity -->
<div class="row g-4 mb-4">
    <!-- Quick Actions -->
    <div class="col-lg-4">
        <div class="quick-actions">
            <div class="section-header">
                <h5 class="section-title mb-0">
                    <i class="bi bi-lightning-fill"></i>
                    {% trans 'Ações Rápidas' %}
                </h5>
            </div>
            <div class="d-flex flex-column gap-3">
                <a href="{% url 'whatsapp_connector:instance_list' %}" class="quick-action-btn">
                    <i class="bi bi-list-ul"></i>
                    <div>
                        <div>{% trans 'Ver Instâncias' %}</div>
                        <small style="font-weight: 400; opacity: 0.7;">{% trans 'Gerenciar conexões' %}</small>
                    </div>
                </a>
                <a href="{% url 'agents:agent_list' %}" class="quick-action-btn">
                    <i class="bi bi-robot"></i>
                    <div>
                        <div>{% trans 'Assistentes IA' %}</div>
                        <small style="font-weight: 400; opacity: 0.7;">{% trans 'Configurar agentes' %}</small>
                    </div>
                </a>
                <a href="{% url 'admin:whatsapp_connector_messagehistory_changelist' %}" class="quick-action-btn">
                    <i class="bi bi-chat-left-text"></i>
                    <div>
                        <div>{% trans 'Histórico Completo' %}</div>
                        <small style="font-weight: 400; opacity: 0.7;">{% trans 'Todas as mensagens' %}</small>
                    </div>
                </a>
                <button onclick="syncInstances()" class="quick-action-btn" style="border: none; cursor: pointer;">
                    <i class="bi bi-arrow-repeat"></i>
                    <div>
                        <div>{% trans 'Sincronizar Tudo' %}</div>
                        <small style="font-weight: 400; opacity: 0.7;">{% trans 'Atualizar dados' %}</small>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <!-- Recent Instances -->
    <div class="col-lg-8">
        <div class="table-container">
            <div class="section-header" style="padding: var(--spacing-xl); padding-bottom: 0;">
                <h5 class="section-title mb-0">
                    <i class="bi bi-clock-history"></i>
                    {% trans 'Instâncias Recentes' %}
                </h5>
                <a href="{% url 'whatsapp_connector:instance_list' %}" class="btn btn-outline-light btn-sm">
                    {% trans 'Ver todas' %}
                </a>
            </div>
            {% if recent_instances %}
                {% for instance in recent_instances %}
                <div class="instance-item">
                    <div class="instance-info">
                        <div class="instance-avatar">
                            <i class="bi bi-phone-fill"></i>
                        </div>
                        <div class="instance-details">
                            <h6>{{ instance.name }}</h6>
                            <small>{{ instance.instance_name }}</small>
                        </div>
                    </div>
                    <div class="d-flex align-items-center gap-3">
                        <div class="text-end d-none d-md-block">
                            <small class="text-muted">{{ instance.created_at|date:"d/m/Y" }}</small><br>
                            <small class="text-muted">{{ instance.created_at|date:"H:i" }}</small>
                        </div>
                        <span class="status-badge status-{{ instance.status }}">
                            {% if instance.status == 'connected' %}
                                <i class="bi bi-circle-fill pulse" style="font-size: 0.5rem;"></i>
                                {% trans 'Conectada' %}
                            {% elif instance.status == 'connecting' %}
                                {% trans 'Conectando' %}
                            {% elif instance.status == 'disconnected' %}
                                {% trans 'Desconectada' %}
                            {% elif instance.status == 'error' %}
                                {% trans 'Erro' %}
                            {% endif %}
                        </span>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="empty-state">
                    <i class="bi bi-inbox"></i>
                    <h5>{% trans 'Nenhuma instância criada ainda' %}</h5>
                    <p>{% trans 'Crie sua primeira instância para começar a usar o WhatsApp' %}</p>
                    <button class="btn btn-primary" onclick="window.location.href='{% url 'whatsapp_connector:instance_create' %}'">
                        <i class="bi bi-plus-circle me-2"></i>
                        {% trans 'Criar Instância' %}
                    </button>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Status Distribution & Latest Messages -->
<div class="row g-4 mb-4">
    {% if status_counts %}
    <!-- Status Distribution -->
    <div class="col-lg-4">
        <div class="table-container">
            <div class="section-header" style="padding: var(--spacing-xl); padding-bottom: 0;">
                <h5 class="section-title mb-0">
                    <i class="bi bi-pie-chart"></i>
                    {% trans 'Status das Instâncias' %}
                </h5>
            </div>
            <div style="padding: var(--spacing-xl);">
                {% for status in status_counts %}
                <div class="d-flex justify-content-between align-items-center py-3 border-bottom" style="border-color: var(--border-light) !important;">
                    <div class="d-flex align-items-center gap-3">
                        <div class="metric-icon-wrapper" style="width: 40px; height: 40px; font-size: 1rem;
                            {% if status.status == 'connected' %}background: rgba(5, 150, 105, 0.1); color: #059669;
                            {% elif status.status == 'connecting' %}background: rgba(245, 158, 11, 0.1); color: #f59e0b;
                            {% elif status.status == 'disconnected' %}background: rgba(220, 38, 38, 0.1); color: #dc2626;
                            {% else %}background: rgba(100, 100, 100, 0.1); color: #666;
                            {% endif %}">
                            <i class="bi
                                {% if status.status == 'connected' %}bi-check-circle-fill
                                {% elif status.status == 'connecting' %}bi-arrow-repeat
                                {% elif status.status == 'disconnected' %}bi-x-circle-fill
                                {% else %}bi-question-circle-fill
                                {% endif %}"></i>
                        </div>
                        <span class="fw-semibold">
                            {% if status.status == 'connected' %}{% trans 'Conectadas' %}
                            {% elif status.status == 'connecting' %}{% trans 'Conectando' %}
                            {% elif status.status == 'disconnected' %}{% trans 'Desconectadas' %}
                            {% elif status.status == 'error' %}{% trans 'Com Erro' %}
                            {% else %}{{ status.status }}
                            {% endif %}
                        </span>
                    </div>
                    <span class="fw-bold" style="font-size: 1.25rem;">{{ status.count }}</span>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Latest Messages -->
    <div class="{% if status_counts %}col-lg-8{% else %}col-12{% endif %}">
        <div class="table-container">
            <div class="section-header" style="padding: var(--spacing-xl); padding-bottom: 0;">
                <h5 class="section-title mb-0">
                    <i class="bi bi-chat-left-text"></i>
                    {% trans 'Últimas Mensagens' %}
                </h5>
                <a href="{% url 'admin:whatsapp_connector_messagehistory_changelist' %}" class="btn btn-outline-light btn-sm">
                    {% trans 'Ver todas' %}
                </a>
            </div>
            {% if latest_messages %}
                {% for message in latest_messages|slice:":5" %}
                <div class="message-preview">
                    <div class="message-avatar">
                        {% if message.sender_name %}
                            {{ message.sender_name|first|upper }}
                        {% else %}
                            <i class="bi bi-person-fill"></i>
                        {% endif %}
                    </div>
                    <div class="message-content">
                        <div class="message-header">
                            <span class="message-sender">
                                {{ message.sender_name|default:"Desconhecido" }}
                            </span>
                            <span class="message-time">{{ message.received_at|date:"H:i" }}</span>
                        </div>
                        <div class="message-text">
                            {% if message.content %}
                                {{ message.content }}
                            {% elif message.message_type == 'image' %}
                                <i class="bi bi-image me-1"></i>{% trans 'Imagem recebida' %}
                            {% elif message.message_type == 'audio' %}
                                <i class="bi bi-mic me-1"></i>{% trans 'Áudio recebido' %}
                            {% else %}
                                <i class="bi bi-file-earmark me-1"></i>{% trans 'Arquivo recebido' %}
                            {% endif %}
                        </div>
                        <div class="message-meta">
                            <span class="status-badge
                                {% if message.message_type == 'text' %}status-connected
                                {% elif message.message_type == 'image' %}bg-info
                                {% elif message.message_type == 'audio' %}bg-warning
                                {% else %}bg-secondary
                                {% endif %}" style="font-size: 0.7rem; padding: 0.25rem 0.5rem;">
                                {{ message.get_message_type_display }}
                            </span>
                            {% if message.evolution_instance %}
                            <small class="text-muted">{{ message.evolution_instance.name }}</small>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="empty-state">
                    <i class="bi bi-chat-square-dots"></i>
                    <h5>{% trans 'Nenhuma mensagem ainda' %}</h5>
                    <p>{% trans 'As mensagens do WhatsApp aparecerão aqui quando você conectar suas instâncias.' %}</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
// Sync instances function
function syncInstances() {
    const btn = event.target.closest('button');
    const icon = btn.querySelector('i');
    const originalIcon = icon.className;

    icon.className = 'bi bi-arrow-clockwise spin';
    btn.disabled = true;

    fetch('{% url "whatsapp_connector:instance_sync" %}')
        .then(() => {
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        })
        .catch(() => {
            icon.className = originalIcon;
            btn.disabled = false;
        });
}

// Update timestamp
function updateTimestamp() {
    const now = new Date();
    const hours = String(now.getHours()).padStart(2, '0');
    const minutes = String(now.getMinutes()).padStart(2, '0');
    document.getElementById('lastUpdate').textContent = `${hours}:${minutes}`;
}

setInterval(updateTimestamp, 60000);

// Add spin animation
const style = document.createElement('style');
style.textContent = `
    .spin {
        animation: spin 1s linear infinite;
    }
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
`;
document.head.appendChild(style);
</script>
{% endblock %}
